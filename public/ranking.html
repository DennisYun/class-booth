<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>랭킹 입력</title>
    <style>
      @font-face {
        font-family: 'RoundedFixedsys';
        src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_six@1.2/DungGeunMo.woff')
          format('woff');
        font-weight: normal;
        font-display: swap;
      }

      body {
        margin: 0;
        padding: 20px;
        font-family: 'RoundedFixedsys';
      }

      #input_section {
        max-width: 1400px;
        margin: 0 auto;
      }

      #tables_wrapper {
        display: flex;
        gap: 40px;
      }

      .game_input {
        flex: 1;
      }

      .game_input h2 {
        text-align: center;
        margin-bottom: 10px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      td {
        border: 1px solid #555;
        padding: 4px;
      }

      input {
        width: 100%;
        box-sizing: border-box;
        border: none;
        font-family: 'RoundedFixedsys';
        font-size: 18px;
        padding: 4px;
      }

      input[type='number'] {
        text-align: right;
      }

      #save_btn {
        display: block;
        margin: 20px auto 0;
        font-family: 'RoundedFixedsys';
        font-size: 20px;
        padding: 10px 40px;
        cursor: pointer;
        position: fixed;
        top: 0;
        right: 0;
      }
    </style>
  </head>

  <body>
    <div id="input_section">
      <div id="tables_wrapper">
        <!-- 사격 게임 -->
        <div class="game_input">
          <h2>사격 게임 입력</h2>
          <table id="shooting_table">
            <thead>
              <tr>
                <th>이름</th>
                <th>시간(초)</th>
                <th>맞춘 개수</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- 콩 옮기기 게임 -->
        <div class="game_input">
          <h2>콩 옮기기 게임 입력</h2>
          <table id="bean_table">
            <thead>
              <tr>
                <th>이름</th>
                <th>시간(초)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <button id="save_btn">저장</button>
    </div>

    <script>
      const shootingTbody = document.querySelector('#shooting_table tbody');
      const beanTbody = document.querySelector('#bean_table tbody');
      const saveBtn = document.getElementById('save_btn');

      function createTable(tableBody, storageKey, cols) {
        for (let i = 0; i < 100; i++) {
          const tr = document.createElement('tr');
          for (let j = 0; j < cols; j++) {
            const td = document.createElement('td');
            const input = document.createElement('input');
            // input.type = 'number';
            input.placeholder = j === 0 ? '이름' : '0';
            td.appendChild(input);
            tr.appendChild(td);

            const key = `${storageKey}_${i}_${j}`;
            // 초기값 로컬스토리지에서 복원
            if (localStorage.getItem(key)) {
              input.value = localStorage.getItem(key);
            }

            input.addEventListener('input', () => {
              localStorage.setItem(key, input.value);
            });
          }
          tableBody.appendChild(tr);
        }
      }

      // 사격: 이름, 시간, 개수
      createTable(shootingTbody, 'shooting', 3);
      // 콩: 이름, 시간
      createTable(beanTbody, 'bean', 2);

      function extractShootingTop() {
        const rows = shootingTbody.querySelectorAll('tr');
        const list = [];
        rows.forEach((row) => {
          const [nameInput, timeInput, countInput] =
            row.querySelectorAll('input');
          const name = nameInput.value.trim();
          const time = parseFloat(timeInput.value);
          const count = parseInt(countInput.value, 10);
          if (name && !isNaN(time) && !isNaN(count)) {
            list.push({ name, time, count });
          }
        });
        // 개수 내림차순, 동률이면 시간 오름차순
        list.sort((a, b) => b.count - a.count || a.time - b.time);
        return list.slice(0, 8);
      }

      function extractBeanTop() {
        const rows = beanTbody.querySelectorAll('tr');
        const list = [];
        rows.forEach((row) => {
          const [nameInput, timeInput] = row.querySelectorAll('input');
          const name = nameInput.value.trim();
          const time = parseFloat(timeInput.value);
          if (name && !isNaN(time)) {
            list.push({ name, time });
          }
        });
        // 시간 오름차순
        list.sort((a, b) => a.time - b.time);
        return list.slice(0, 8);
      }

      saveBtn.addEventListener('click', async () => {
        const result = {
          shooting: extractShootingTop(),
          bean: extractBeanTop(),
        };

        console.log('결과 JSON:', JSON.stringify(result, null, 2));

        try {
          const res = await fetch('/rankedit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(result),
          });

          const data = await res.json();
          if (data.success) {
            alert('랭킹 저장 완료!');
          } else {
            alert('저장 실패');
          }
        } catch (err) {
          console.error(err);
          alert('서버 통신 오류');
        }
      });
    </script>
  </body>
</html>
